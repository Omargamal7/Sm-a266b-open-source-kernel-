name: Import Drive files (IDs) -> sort -> extract -> commit

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip p7zip-full rsync zstd file
          python3 -m pip install --upgrade pip gdown

      - name: Download Drive IDs
        run: |
          mkdir -p _inbox && cd _inbox
          ids=(1Ct8x1k6qSEuFpsfG6_L0ma_PENAhUMGw 1Cm0Ik6DCXUxyKBBkDJjWL_tKDIx2FaBL 1ddANiZ1HuK02fgyRDWjw43zFmjgkVkwE
               1WCQp_FtMA_mXQMC6E8H2dEsAamZoW5tS 1vHgoVnhv-rZ9DFtEWFjXTTDIH-PnB7OP 1YvjfvJZ_Fad6YbmXaILtg2-BQtVDWo4q
               1zEzWx8NgkifsqjwGUJXr1VzigMJj4apc 1iasfEq6Smybt5kUedkRlxUe6JYHS5rih 1xqWwe48Rq5SMyEHlXl1JP-LXvy6oqdps
               1aHpV1Ci--MDG5HnjhEO3DJH7ddC2noAI 1opiD3V9r1MhM7R7eeKFLufJM9eeJK1E- 1MDuAOg6vsFLHd3uPF9D7xsKd8LhJK1sg
               1bDEaCQ2D9DXTW3L_80B4_oYwPl4cA-Gf 14B1_Wzovks9xyOcst5h2h7QIzuWgeurr 1QQyoh8te2k8fqngRZE7KNctlF3P9KaUd
               165IQgq2FCaN3ZcmTzpGI25ErUrmAag5J 1Nz0pEsxwqg6mAWTmGeKkszXsXpKV1jsB 1Txi0ddO_VFVpaEYTLV4rEY-fU4f1Axe7
               1Ogikw-SwCivQJxtsSfrLmnQ5WyGmzS94 1JD2TTSSM73kA52F-TZxy5FVzHs-NOkNx 1Hg_tUYeLZlTGIBOm3wEKNDz_yJ0rXah-
               19YYMm7J0VJnBbxGl8JzViAl1oDpmfZzz 1RhBkBp7xuZrNskXz-uC3Y_5UNf2x6IPp)
          for id in "${ids[@]}"; do gdown --id "$id" --no-cookies --continue --remaining-ok; done

      - name: Create target dirs
        run: |
          rm -rf kernel twrp magisk wildksu
          mkdir -p kernel/opensource kernel/platform twrp magisk wildksu

      - name: Sort & map
        run: |
          :> IMPORT_MAP.txt
          for f in _inbox/*; do
            b=$(basename "$f"); d=kernel/opensource; l=${b,,}
            [[ $l == *platform* ]] && d=kernel/platform
            [[ $l == *twrp* || $l == *recovery* ]] && d=twrp
            [[ $l == *wildksu* || $l == *kernelsu* || $l == *ksu* ]] && d=wildksu
            [[ $l == *magisk* ]] && d=magisk
            echo "$b -> $d" >> IMPORT_MAP.txt
            mv "$f" "$d/"
          done
          rm -rf _inbox

      - name: Extract (skip magisk)
        run: |
          ext(){ case "${1,,}" in *.zip) unzip -o "$1" -d "$2" >/dev/null && rm "$1";;
                                   *.7z) 7z x -y -o"$2" "$1" >/dev/null && rm "$1";;
                                   *.tar|*.tar.*|*.tgz) tar -xf "$1" -C "$2" && rm "$1";; esac; }
          for d in kernel/opensource kernel/platform twrp wildksu; do
            for f in "$d"/*; do [ -f "$f" ] && ext "$f" "$d"; done; done

      - name: Fail if any file >95MB
        run: |
          if find . -type f -not -path "./.git/*" -size +95M | grep -q .; then
            echo "Large file found >95MB"; exit 1; fi

      - name: Commit & push
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name cloud-import-bot
            git config user.email cloud-import-bot@users.noreply.github.com
            git add -A && git commit -m "Import Drive files" && git push
          fi
